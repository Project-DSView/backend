# Traefik Dynamic Router Configuration
# Host-based routing with TLS (matching original Docker label config)

http:
  routers:
    # ============================================================
    # Traefik Dashboard — Secured with BasicAuth + IP Whitelist
    # ============================================================
    dashboard-router:
      rule: "Host(`traefik.lvh.me`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      service: "api@internal"
      entryPoints:
        - "web"
      middlewares:
        - "dashboard-auth"
        - "dashboard-ipwhitelist"

    # FastAPI Service Router (Host-based, HTTPS)
    fastapi-router:
      rule: "Host(`fastapi.lvh.me`)"
      service: "fastapi-service"
      entryPoints:
        - "websecure"
      tls: {}

    # FastAPI Service Router (Host-based, HTTP)
    fastapi-router-http:
      rule: "Host(`fastapi.lvh.me`)"
      service: "fastapi-service"
      entryPoints:
        - "web"

    # Go Service Router (Host-based, HTTPS)
    go-router:
      rule: "Host(`go.lvh.me`)"
      service: "go-service"
      entryPoints:
        - "websecure"
      tls: {}

    # Go Service Router (Host-based, HTTP)
    go-router-http:
      rule: "Host(`go.lvh.me`)"
      service: "go-service"
      entryPoints:
        - "web"

    # Frontend Router (HTTP)
    frontend-router:
      rule: "Host(`dsview.lvh.me`)"
      service: "frontend-service"
      entryPoints:
        - "web"

    # Path-based fallback routers (HTTP) for internal routing
    fastapi-path-router:
      rule: "PathPrefix(`/fastapi`)"
      service: "fastapi-service"
      middlewares:
        - fastapi-stripprefix
      entryPoints:
        - "web"

    go-path-router:
      rule: "PathPrefix(`/go`)"
      service: "go-service"
      middlewares:
        - go-stripprefix
      entryPoints:
        - "web"

  # ============================================================
  # Middlewares
  # ============================================================
  middlewares:
    # BasicAuth for dashboard
    # Default: admin / DsV!ew@2026  (change this!)
    # Generate new hash: htpasswd -nB admin
    dashboard-auth:
      basicAuth:
        users:
          - "admin:$2y$05$YzQ5NzFmZGQ4OGRiNOIxZuZjNmM0ZGEzYjNmNzJiYTRiZWRiZTJl"

    # IP whitelist — only allow local/private network access
    dashboard-ipwhitelist:
      ipAllowList:
        sourceRange:
          - "127.0.0.1/32"
          - "10.0.0.0/8"
          - "172.16.0.0/12"
          - "192.168.0.0/16"

  services:
    # Frontend Service
    frontend-service:
      loadBalancer:
        servers:
          - url: "http://dsview-frontend:3000"

    # FastAPI Service
    fastapi-service:
      loadBalancer:
        servers:
          - url: "http://fastapi-backend:8000"
        healthCheck:
          path: "/health"
          interval: "30s"
          timeout: "5s"

    # Go Service
    go-service:
      loadBalancer:
        servers:
          - url: "http://go-backend:8080"
        healthCheck:
          path: "/health"
          interval: "30s"
          timeout: "5s"
